# Copilot Instructions for BiatecCLAMM

- **Architecture**: Core smart contracts live in `contracts/*.algo.ts`, written in TEALScript and compiled to TEAL artifacts consumed by generated clients under `contracts/clients`. Front-end oriented wrappers and transaction builders reside in `src/` and re-exported via `src/index.ts` for the published package.
- **Key Contracts**: `BiatecClammPool.algo.ts` governs concentrated liquidity maths (SCALE = 1_000_000_000, LP decimals = 6) and enforces config/identity apps. Config (`BiatecConfigProvider.algo.ts`), identity (`BiatecIdentityProvider.algo.ts`), and pool registry (`BiatecPoolProvider.algo.ts`) set permissions, fees, and box layouts.
- **Generated Clients**: Files in `contracts/clients` are produced by `npm run generate-client`; never hand-edit them. Whenever you change TEALScript sources, run `npm run compile-contract` followed by `npm run generate-client` (or simply `npm run build`).
- **Transaction Builders**: Use helpers in `src/biatecClamm/txs` (e.g., `clammAddLiquidityTxs`, `clammCreateTxs`) to assemble properly grouped transactions with required box/app references. These functions add companion pool-provider NOOPs and optional LP opt-ins—mirroring the flow expected by on-chain logic.
- **Sender Shortcuts**: `src/biatecClamm/sender/*` functions wrap the tx builders, fetch global state (fee, price bounds, verification class), and submit signed groups via Algod. Prefer them over hand-rolled submissions when scripting user flows.
- **Box Naming**: Pool-provider boxes follow byte prefixes: `'p'+poolId` for per-pool stats, `'s'+assetA+assetB` for aggregated pairs, `'a'+assetId` for asset metadata, and `'capb*'` segments when streaming approval programs. Reuse helpers in `src/biatecPools` and `src/boxes` to avoid mismatched encodings.
- **Decimals & Scaling**: The contracts convert asset balances into a 1e9 base scale (`assetADecimalsScaleFromBase`, etc.) before computing liquidity or swaps. Maintain this pattern in off-chain math and clamp BigInt rounding the same way tests expect to prevent LP bleed.
- **Identity Enforcement**: Every liquidity and swap method calls `verifyIdentity`, checking the config app for linked identity and minimum verification class. Off-chain helpers must always include `appBiatecConfigProvider` and `appBiatecIdentityProvider` references plus the correct identity box (`getBoxReferenceIdentity`).
- **Fees**: Liquidity fees (`fee`) and Biatec fee share come from config global state and influence liquidity accounting (`LiquidityUsersFromFees`, `LiquidityBiatecFromFees`). Tests assert liquidity strictly increases on swaps; preserve that invariant when adjusting maths.
- **LP Minting vs Fees**: `processAddLiquidity` solves the quadratic that discounts historic `LiquidityUsersFromFees` and floors the positive root before minting LP tokens. Mirror that calculation off-chain (including the floor) so you do not assume `newLiquidity - oldLiquidity` maps 1:1 to minted supply when fees are present.
- **Rounding Expectation**: Flooring the LP mint means immediate withdrawals can trail deposits by a few base units, always in favour of the pool. Tests now assert `delta <= 0` with a tiny negative tolerance; treat any larger deficit as a regression.
- **Testing Workflow**: Jest suites under `__test__/` rely on `algorandFixture()` from `@algorandfoundation/algokit-utils/testing`. They expect Algorand sandbox credentials and call `algokit.Config.configure({ populateAppCallResources: true })`. Run `npm run test` for a full compile + test cycle, `npm run test:nobuild` after artifacts are fresh, or targeted cases via `npm run test:1:nobuild`. Treat green tests as a release gate—never merge without running the affected suites.
- **Test Suites**: Legacy pool specs now live in focused files under `__test__/pool/*.test.ts`, with deterministic inputs stored in `__test__/pool/test-data/*.json` and loaded via `convertToBigInt`. The aggregator `__test__/BiatecClammPool.test.ts` simply imports each module so older commands keep working. When adding coverage, place helpers in `__test__/pool/shared-setup.ts`, keep new data beside the suite, and update the JSON fixtures when scenarios change.
- **Deployment & Scripts**: `npm run deploy` (ts-node) and shell scripts in the repo assume sandbox settings from `sandbox_/`; keep them updated when contract interfaces change.
- **Logging**: Use `src/common/getLogger.ts` for Winston-based logging with rotating files if you need persistent logs in CLI scripts.
- **Packaging**: Library consumers import from the built `dist` bundle created by `npm run build-package` (tsup). Exported surface is curated in `src/index.ts`; add new utilities there when you want them published.
- **Style & Lint**: Follow AirBnB + Prettier config via `npm run lint` / `npm run fix`. Most source files use BigInt literals (`1n`) and avoid floating math—stick with that convention.
- **Typical Flow**: Deploy config/identity/pool apps, load CLAMM approval chunks through the pool provider, call `clammCreateTxs` to instantiate pools, run `bootstrapStep2`, then manage liquidity via `clammAddLiquiditySender`/`clammRemoveLiquiditySender` and swaps via `clammSwapSender`.
- **Fixture Pattern**: `__test__/BiatecClammPool.test.ts` drives end-to-end flows through `setupPool`, which funds accounts, compiles approval programs in 1KB chunks, and calls `bootstrapStep2`. Mirror that sequence in new integration tests.
- **Sandbox Funding**: Pool creation expects a 400_000 µAlgo seed payment plus additional 7_000_000 µAlgo to the pool provider; ensure your accounts are prefunded before calling `clammCreateTxs`.
- **Buffer Utilities**: All box names use ASCII prefixes with `algosdk.bigIntToBytes` padding to 8 bytes. Reuse helpers (`getBoxReference*`) instead of building names inline to avoid encoding mistakes.
- **State Access**: When sender helpers read `appClient.state.global.getAll()`, keys surface in camelCase (e.g., `priceMin`); maintain those labels when referencing state to prevent undefined access.
- **Common Pitfalls**: Forgetting to opt into LP tokens, missing box references in grouped transactions, or skipping config app references will cause on-chain assertions (`E_CONFIG`, `ERR-LOW-VER`) seen throughout the TEALScript. Use provided helpers to avoid these errors.

## Error handling

- On error `couldn't find the default account in KMD` run command `algokit localnet reset` and run tests again
